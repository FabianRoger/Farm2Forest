---
title: Farm typology"
output: html_notebook
---

load libraries



```{r}
library(sf) 
#library(raster)
library(vegan)
library(readr)
library(ggplot2)
library(plotly)
library(readxl)
library(dplyr)
library(tidyr)
library(multidplyr)
library(kohonen)
library(cluster)
library(purrr)
library(forcats)
library(RColorBrewer)
library(igraph)



```


### import selected Farms 

```{r}
RPD_2012_sub <- st_read("RPD_2012_sub.gpkg")
```


### LiveStock database 

+ containing data from 2005 to 2012
+ we filter out data for 2012 only


```{r}
Livestock <- read_csv("/Volumes/Fabian_Work/SJV_DATA/livestock_numbers.csv")
Encoding(Livestock$djur)<- "latin1"

Livestock <- 
Livestock %>% 
  filter(ar == 2012) 
  
  
head(Livestock)
```


```{r}
Livestock %>% 
  mutate(N_kundnr = 4 - (is.na(kundnr1) + is.na(kundnr2) + is.na(kundnr3) + is.na(kundnr4))) %>% 
  select(N_kundnr) %>% 
  table()
```

There are up to 4 kundnr per customer in the Livestock database and some entries have no kundnr. We only take the first one into account and remove the remaining 3. records without kundr will be filtered out when we join the data.

```{r}
Livestock <- Livestock %>% 
  select(-kundnr2, -kundnr3, -kundnr4)
```


+ check of correspondance between the lifestock datatbase and the Blockdatabase

`%` of customer number from 2012 Livestock database also present in full RPD

```{r}
RPD_2012 <- st_read("/Volumes/Fabian_Work/Reference parcel data shapelayers/S_jbb2012.shp")
RPD_2012 <-  mutate(RPD_2012, kundnr1 = paste(lan, kundnr, sep = " "))

kundnr_in_RPD <- 
Livestock %>% 
  select(kundnr1) %>%
  distinct() %>% 
  mutate(N = n()) %>% 
  filter(kundnr1 %in% RPD_2012$kundnr1) %>% 
  summarise(kundnr_in_RPD = n(), N = unique(N)) %>% 
  mutate(`%` = 100* kundnr_in_RPD/N)

rm(RPD_2012)  

kundnr_in_RPD
```

all but one kundnr from the Livestock database is found in the RPD database 


`%` of customer number in subsetted RDP in Livestock database
(how many farms have any livestock?)

```{r, eval = TRUE}
RPD_2012_sub %>%
  st_set_geometry(NULL) %>% 
  select(region, kundnr1) %>% 
  distinct() %>% 
  mutate(in_livestock = kundnr1 %in% Livestock$kundnr1) %>% 
  group_by(region) %>% 
  summarise(`% kundnr with livestock` = round(sum(in_livestock) / n() * 100, 1))
  
```



### load crop_codes

`grodkod` contains the cropcodes as they have been defined through the years, from 1999 to 2012. We keep the definition for 2012 unless the cropcode is undefined in 2012 in which case we take the definition from the last year it is defined. 

```{r, eval = TRUE}
crop_codes <- 
  read_xlsx("/Volumes/Fabian_Work/SJV_DATA/crop_codes_english.xlsx") %>% 
  group_by(`Landuse code`) %>% 
  filter(year == max(year)) %>% 
  rename(grodkod = `Landuse code`) %>% 
  rename(cropcode_year = year) %>% 
  ungroup %>% 
  mutate(grodkod = as.numeric(grodkod)) %>% 
  select(-Swedish) %>% 
  dplyr::rename(crop_name = English)

head(crop_codes)
```


## join data

+ join livestock data to the blockdatabase 
+ join crop codes to the blockdatabase

```{r, eval = TRUE}
Livestock <- Livestock %>% 
  select(djurid, djur, antal, kundnr1) %>% 
  distinct()

RPD_2012_sub <- left_join(RPD_2012_sub, Livestock)

RPD_2012_sub <- left_join(RPD_2012_sub, crop_codes)

as_tibble(RPD_2012_sub)
```



##  distribution of land are per kundnr
+ `blockarea` gives the area of the block, which corresponds to the area of the shape in the `geometry` column
+ `areal` gives the are of the crop *within* each block

```{r}

RPD_2012_sub %>% 
  st_set_geometry(NULL) %>%
  select(region, kundnr1, blockid, grodkod, areal) %>% 
  distinct() %>% 
  group_by(region, kundnr1) %>% 
  summarise(tot_area = sum(areal)) %>% 
  mutate(median = median(tot_area)) %>% 
  ggplot(aes(x = tot_area, fill = region)) +
  geom_histogram(binwidth = 0.1, alpha = 0.8)+
  stat_density(geom="line", aes(y=0.1 * ..count..), colour = "blue", size = 1)+
  geom_vline(aes(xintercept = median))+
  geom_text(aes(label = round(median), x = median+100, y = 250))+
  facet_wrap(~region, nrow = 1)+
  scale_x_log10()+
  theme_minimal()+
  labs(x = "total farm size in ha", title = "log-normal distribution of land area per kundnr" )+
  scale_fill_brewer(palette = "Set1")

```

### median of field size by region

+ one field is defined as on grodkod on one block
*right now I take the median of all cropcodes, e.g. including things like flowerstrips which will skew the field size down a bit*

```{r}

RPD_2012_sub %>% 
  st_set_geometry(NULL) %>%
  select(region, kundnr1, blockid, grodkod, areal) %>% 
  distinct() %>% 
  group_by(region, kundnr1 ) %>% 
  summarise(median_field = median(areal)) %>%
  group_by(region) %>% 
  mutate(median = median(median_field)) %>% 
  ggplot(aes(x = median_field, fill = region)) +
  geom_histogram(binwidth = 0.1, alpha = 0.8)+
  stat_density(geom="line", aes(y=0.1 * ..count..), colour = "blue", size = 1)+
  geom_vline(aes(xintercept = median))+
  geom_text(aes(label = signif(median,2), x = median+10, y = 250))+
  facet_wrap(~region, nrow = 1)+
  scale_x_log10()+
  theme_minimal()+
  labs(x = "total farm size in ha", title = "log-normal of median field sizes")+
  scale_fill_brewer(palette = "Set1")
  

```

```{r}

RPD_2012_sub %>% 
  st_set_geometry(NULL) %>%
  select(region, kundnr1, blockid, grodkod, areal) %>% 
  distinct() %>% 
  group_by(region, kundnr1 ) %>% 
  summarise(tot_size = sum(areal),
            median_field = median(areal),
            min_field = quantile(areal, 0.05),
            max_field = quantile(areal, 0.95)) %>%
  group_by(region) %>% 
  arrange(tot_size) %>% 
  mutate(rank = 1:n()) %>% 
  ggplot(aes(colour = region)) +
  geom_errorbar(aes(x = rank, ymin = min_field, ymax = max_field),
                  alpha = 0.3)+
  geom_point(aes(x = rank, y = median_field), colour = "black", size = 0.5)+
  facet_wrap(~region, nrow = 1, scales = "free")+
  theme_minimal()+
  labs(x = "farm size in ha", y = "field size range in ha")+
  #scale_x_continuous(limits = c(0,10))+
  scale_colour_brewer(palette = "Set1")
  

```



### distance from fields 

### load data about location of Farmsteads 
```{r}
Farmstead <- read_delim("/Volumes/Fabian_Work/Brukare_brukningscentrum_ansi.txt", delim = "\t", locale = locale(encoding = "latin1")) %>% 
  select(`Block Id`, Kundnr,`Brukningscentrum JA/NEJ`) %>% 
  rename(blockid = `Block Id`,
         kundnr1 = Kundnr,
         Farm = `Brukningscentrum JA/NEJ`) %>% 
  filter(Farm == "Ja")
```

## shortest path to visit all fields

+ this is a step-by-step walk-through how I calculate the shortest path

1) subset for one kundr
2) calculate centroid of each field

(we also join the info about the Farmstead but we do not use it in the calculations yet)
```{r}

# large network : "F 3311"
# small network : "F 10234"
test <- 
RPD_2012_sub %>% 
  filter(kundnr1 =="F 10234" ) %>% 
  left_join(Farmstead) %>% 
  select( Farm) %>% 
  distinct() %>% 
  rename(geometry = geom) %>% 
  mutate(centroids = st_centroid(geometry)) 

test %>% 
  ggplot(., aes(colour = Farm))+
  geom_sf()+
  geom_sf(aes(geometry = centroids), size = 0.2, colour = "blue")+
  theme_bw()+
  theme(legend.position = "none")
```
+ transform centroids in linestring object containing all path between centroids

3) extract all centroids and arrange them in matrix
4) combine centroids in all possible combinations to get all path between centroids
5) make multilinestring sf object from list and res-set crs
6) cast to linestring and transform it to spatial dataframe (with random feature)
```{r}
test_LS <- matrix(unlist(test$centroids), ncol =2, byrow = T)
comb <- combn(c(1:nrow(test_LS)),2)

test_LS <- 
  apply(comb, 2, function(x) list(test_LS[x,])) %>% 
  unlist(recursive = F) %>% 
  st_multilinestring() %>% 
  st_sfc() %>% 
  st_set_crs(st_crs(test)) 

test_LS <- st_cast(test_LS, "LINESTRING")
test_LS <- st_sf(a = sample(LETTERS, ncol(comb), replace = T), 
                 geom = test_LS)


test %>% 
  ggplot(.)+
  geom_sf(aes(colour = Farm))+
  geom_sf(aes(geometry = centroids), colour = "blue", size = 0.2)+
  geom_sf(data = test_LS, size = 0.05, alpha = 0.1)+
  theme_bw()
```

+ transform to graph

7) transform to class `SpatialLinesDataFrame`
8) use the `readshpnw` function from the `shp2graph` package to extract nodes, edges and calculate distances between nodes
9) use `nel2igraph` function to convert it to a weighted graph of class `igraph`

```{r}
Test_sp <- as(test_LS, 'Spatial') 

Graph <- readshpnw(Test_sp, 
                   ea.prop = c(0),
                   ELComputed = T, 
                   longlat = T)
                   
g = nel2igraph(Graph[[2]],
               Graph[[3]], 
               weight=Graph[[4]])

plot(g)
```
+ find shortest path connecting all edges

I use the travelling salesman package `TSP` to find the shortest path connecting all fields

10) calculate distance matrix between all edges and transform to `TSP` object
11) calculate shortest path. **OBS** this uses a heuristic and is not necesarily the best solution 

```{r}
TSP_obj <- TSP(distances(g))
TSP_sol <- solve_TSP(TSP_obj,
                    # method = "farthest_insertion",
                     repetitions = 100)

L <- labels(TSP_sol)
L <- c(L[1], rep(L[-c(1, length(L))], each = 2), L[length(L)]) %>% 
  as.numeric()

g %>% 
  set_edge_attr( "color", value = "grey") %>% 
  set_edge_attr( "color", value = "red",index = get.edge.ids(g, L)) %>% 
  plot

test_LS$SP <- ""
test_LS$SP[get.edge.ids(g, L)] <- "yes"

test %>% 
  ggplot(.)+
  geom_sf(aes(colour = Farm))+
  geom_sf(aes(geometry = centroids), colour = "blue", size = 0.2)+
  geom_sf(data = filter(test_LS, SP == "yes"),
          colour = "darkred", size = 0.2, alpha = 0.1)+
  theme_bw()+
  theme(legend.position = "none")
```


### what are the most important crops by area

```{r}

p <- RPD_2012_sub %>% 
  st_set_geometry(NULL) %>% 
  select(region, grodkod, areal, blockid) %>% 
  distinct() %>% 
  group_by(region, grodkod) %>% 
  summarise(area_crop = sum(areal)) %>% 
  arrange(region, desc(area_crop)) %>% 
  left_join(select(crop_codes, grodkod, crop_name)) %>% 
  mutate(rank = dense_rank(desc(area_crop))) %>% 
  ungroup() %>% 
  mutate(LS_group = ifelse(rank <= 6, crop_name, "other")) %>% 
  mutate(LS_group = fct_relevel(LS_group, "other", after = 0)) %>% 
  rename(Crop = "crop_name") %>% 
  mutate(Area = paste(signif(area_crop / 1000, 2), "tsd ha")) %>%  
  ggplot(aes(x = region, y = area_crop, fill = LS_group, label = Crop, label2 = Area))+
  geom_bar(stat = "identity", colour = "white", size = 0.1)+
  theme_minimal()+
  theme(legend.position = "bottom")+
  guides(fill=guide_legend(ncol = 2,byrow=F, reverse = T))+
  scale_fill_brewer(palette = "Paired")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
  
ggplotly(p, tooltip = c("label2", "label")) %>% layout(legend = list(orientation = "h", x = 0, y =-1))
```

+ How does it look only for grazing land?

```{r}

# biodiversity fallow...............................69
# bird field........................................17
# fallow............................................60
# fallow............................................62
# forest pasture....................................54
# ley...............................................50
# ley  (non eligible)...............................51
# mosaic pastures...................................96
# mountain pasture (eligible).......................61
# mountain pasture (non-eligible)...................55
# mown meadow.......................................53
# mown meadow (non-eligible)........................98
# mown meadow (no single-payer).....................19
# non-approved crop (pasture).......................92
# non-approved ley (contains non-ley species).......49
# pasture...........................................52
# pasture (non-eligible)............................97
# pasture under restoration.........................95
# pasture (no single-payer).........................18
# unused pasture....................................89


p <- RPD_2012_sub %>%
  st_set_geometry(NULL) %>% 
  select(region, grodkod, areal, blockid) %>% 
  distinct() %>% 
  filter(grodkod %in% c(69,17,60,62,54,50,51,96,61,55,
                        53,98,19,92,49,52,97,95,18,89)) %>% 
  group_by(region, grodkod) %>% 
  summarise(area_crop = sum(areal)) %>% 
  arrange(region, desc(area_crop)) %>% 
  left_join(select(crop_codes, grodkod, crop_name)) %>% 
  mutate(rank = dense_rank(desc(area_crop))) %>% 
  ungroup() %>% 
  mutate(LS_group = ifelse(rank <= 4, crop_name, "other")) %>% 
  mutate(LS_group = fct_relevel(LS_group, "other", after = 0)) %>% 
  rename(Crop = "crop_name") %>% 
  mutate(Area = paste(signif(area_crop / 1000, 2), "tsd ha")) %>%  
  ggplot(aes(x = region, y = area_crop, fill = LS_group, label = Crop, label2 = Area))+
  geom_bar(stat = "identity", colour = "white", size = 0.1)+
  theme_minimal()+
  theme(legend.position = "bottom")+
  guides(fill=guide_legend(ncol = 2,byrow=F, reverse = T))+
  scale_fill_brewer(palette = "Paired")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

p  
```




+ How does it look for lifestock?

```{r}
p <- 
RPD_2012_sub %>% 
  st_set_geometry(NULL) %>% 
  select(region, djurid,djur, antal) %>% 
  distinct() %>% 
  filter(!is.na(djurid)) %>% 
  group_by(region, djur) %>% 
  summarise(antal_djur = sum(antal)) %>% 
  arrange(region, desc(antal_djur)) %>% 
  mutate(rank = dense_rank(desc(antal_djur))) %>% 
  ungroup() %>% 
  mutate(LS_group = ifelse(rank <= 4, djur, "other")) %>%
  mutate(LS_group = fct_relevel(LS_group, "other", after = 0)) %>% 
  rename(Djur = "djur") %>% 
  mutate(Antal = paste(signif(antal_djur / 1000, 3), "tsd")) %>%  
  ggplot(aes(x = region, y = antal_djur, fill = LS_group, label = Djur, label2 = Antal))+
  geom_bar(stat = "identity")+
  theme_minimal()+
  #theme(legend.position = "bottom")+
  guides(fill=guide_legend(ncol = 4,byrow=F, reverse = T))+
  scale_fill_manual(values=c(brewer.pal(8,"Paired"),brewer.pal(8,"Spectral")))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplotly(p, tooltip = c("label", "label2")) %>% layout(legend = list(orientation = "h", x = 0, y =-1))
```

+ group Lifestock in broader classes

```{r}
Livestock_groups <- read_csv2("Livestock_id.csv")

p <- 
RPD_2012_sub %>% 
  st_set_geometry(NULL) %>% 
  left_join(Livestock_groups) %>% 
  select(region, djurid,antal, Type) %>% 
  distinct() %>% 
  filter(!is.na(djurid)) %>% 
  group_by(region, Type) %>% 
  summarise(antal_djur = sum(antal)) %>% 
  arrange(region, desc(antal_djur)) %>% 
  mutate(rank = dense_rank(desc(antal_djur))) %>% 
  ungroup() %>% 
  mutate(Type = fct_relevel(Type)) %>% 
  rename(Djur = Type) %>% 
  mutate(Antal = paste(signif(antal_djur / 1000, 3), "tsd")) %>%  
  ggplot(aes(x = region, y = antal_djur, fill = Djur, label = Djur, label2 = Antal))+
  geom_bar(stat = "identity")+
  theme_minimal()+
  #theme(legend.position = "bottom")+
  guides(fill=guide_legend(ncol = 4,byrow=F, reverse = T))+
  scale_fill_manual(values=c(brewer.pal(8,"Paired"),brewer.pal(8,"Spectral")))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplotly(p, tooltip = c("label", "label2")) %>% layout(legend = list(orientation = "h", x = 0, y =-1))
```


+ convert in lifestock units

```{r}

p <- 
RPD_2012_sub %>% 
  st_set_geometry(NULL) %>% 
  left_join(Livestock_groups) %>% 
  select(region, djurid,antal, LSUC, Type) %>% 
  distinct() %>% 
  filter(!is.na(djurid)) %>% 
  mutate(antal = antal*as.numeric(LSUC)) %>% 
  group_by(region, Type) %>% 
  summarise(antal_djur = sum(antal)) %>% 
  arrange(region, desc(antal_djur)) %>% 
  mutate(rank = dense_rank(desc(antal_djur))) %>% 
  ungroup() %>% 
  mutate(Type = fct_relevel(Type)) %>% 
  rename(Djur = Type) %>% 
  mutate(Antal = paste(signif(antal_djur / 1000, 3), "tsd")) %>%  
  ggplot(aes(x = region, y = antal_djur, fill = Djur, label = Djur, label2 = Antal))+
  geom_bar(stat = "identity")+
  theme_minimal()+
  #theme(legend.position = "bottom")+
  guides(fill=guide_legend(ncol = 4,byrow=F, reverse = T))+
  scale_fill_manual(values=c(brewer.pal(8,"Paired"),brewer.pal(8,"Spectral")))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplotly(p, tooltip = c("label", "label2")) %>% layout(legend = list(orientation = "h", x = 0, y =-1))
```
## clustering Farms by size

```{r}
RPD_size <- 
RPD_2012_sub %>% 
  st_set_geometry(NULL) %>% 
  select( blockid, kundnr1, grodkod, areal) %>% 
  distinct %>% 
  group_by(kundnr1) %>% 
  summarise(size = sum(areal))

RPD_size <- matrix(RPD_size$size, ncol = 1, dimnames = list(RPD_size$kundnr1, "Size") )


Results <- tibble(Cluster = 1:20) %>% 
  mutate(kmeans = purrr::map(Cluster, ~kmeans(RPD_size, .x, nstart = 10))) 

Results <-   
Results %>% 
  mutate(stats = purrr::map(kmeans, glance)) %>% 
  unnest(stats)

Results %>% 
  select(Cluster, tot.withinss, betweenss) %>% 
  gather(index, value, -Cluster) %>% 
  ggplot(aes(Cluster, value))+
  facet_wrap(~index)+
  geom_line()+
  geom_point()

```

The clustering suggests 5 size classes

```{r}

k_mean <- kmeans(RPD_size, 5, nstart = 100)

Centers <- 
  as.data.frame(k_mean$centers) %>% 
  rownames_to_column(var = "Cluster") %>% 
  mutate(Cluster = as.factor(Cluster)) %>% 
  mutate(Cluster = fct_reorder(Cluster, Size))

Size <- 
data.frame(size = k_mean$size) %>% 
  rownames_to_column(var = "Cluster") %>% 
  mutate(Cluster = as.factor(Cluster)) %>% 
  mutate(Cluster = fct_reorder(Cluster, size))

Clusters <- 
k_mean$cluster %>% 
  data.frame(Cluster = `.`) %>% 
  rownames_to_column(var = "kundnr1") %>%
  left_join(rownames_to_column(as.data.frame(RPD_size), var = "kundnr1")) %>% 
  left_join(distinct(select(st_set_geometry(RPD_2012_sub, NULL), kundnr1, region))) %>% 
  mutate(Cluster = as.factor(Cluster)) %>% 
  mutate(Cluster = fct_reorder(Cluster, Size))

Clusters %>% 
  ggplot(aes(x = as.factor(Cluster), y = Size))+
  #geom_boxplot(outlier.size = 1, outlier.alpha = 0.3, fill = NA)+
  geom_point(aes(colour = region), position = position_jitterdodge(jitter.width = 0.2), alpha = 0.3)+
  geom_point(data = Centers, aes(x = as.factor(Cluster), y = Size), colour = "black", size = 2, shape = 21)+
  geom_text(data = Size, aes(x = as.factor(Cluster), y = 700, label = size))+
  theme_bw()+
  scale_colour_viridis_d()

Clusters %>% 
  mutate(Cluster = as.factor(Cluster)) %>% 
  mutate(Cluster = fct_reorder(Cluster, Size)) %>% 
  ggplot(., aes(x = Size, fill = factor(Cluster)))+
  geom_histogram(position = "dodge", binwidth = 2)+
  theme_bw()+
  facet_grid(Cluster~., scales = "free_y")+
  scale_fill_brewer(palette = "Set1")


```

##correspondance between Farm size and Lifestock units

```{r}

Farm_size <- 
RPD_2012_sub %>% 
  st_set_geometry(NULL) %>%
  select(kundnr1, region, blockid, grodkod, areal) %>% 
  distinct() %>% 
  group_by(kundnr1,region) %>% 
  summarise(areal = sum(areal))
  
Farm_LS <- 
  RPD_2012_sub %>% 
  st_set_geometry(NULL) %>%
  select(kundnr1, djurid, antal) %>% 
  distinct() %>% 
  left_join(Livestock_groups) %>% 
  group_by(kundnr1) %>% 
  mutate(LSUC = as.numeric(LSUC)) %>% 
  mutate(antal = antal * LSUC) %>% 
  summarise(LSU_sum = sum(antal)) %>% 
  mutate(LSU_sum = ifelse(is.na(LSU_sum), 0, LSU_sum))

left_join(Farm_size, Farm_LS) %>% 
  ggplot( aes( x = LSU_sum, y = areal, colour = region))+
  geom_point(alpha = 0.5)+
  facet_wrap(~region, nrow = 2)+
  geom_abline(intercept = c(0,0), slope = 1)+
  scale_color_brewer(palette = "Set1")+
  theme_bw()+
  scale_y_continuous(limits = c(0,500))+
  scale_x_continuous(limits = c(0,500))

RPD_2012_sub %>% 
  st_set_geometry(NULL) %>% 
  select(blockid, kundnr1) %>% 
  distinct() %>% 
  group_by(blockid) %>% 
  summarise(n = n()) %>% 
  select(n) %>% 
  table()

```



## clustering Farms by cropcodes


+ making a matrix of Farms (rows) and cropcodes (columns) with the area of each cropcode in each farm
```{r}
RPD_CC <- 
RPD_2012_sub %>% 
  st_set_geometry(NULL) %>% 
  select(region, kundnr1, blockid, areal, grodkod) %>% 
  distinct() %>% 
  group_by(region, kundnr1, grodkod) %>% 
  summarise(area = sum(areal)) %>% 
  spread(grodkod, area, fill = 0) %>% 
  ungroup() %>% 
 # filter(region == "Skåne") %>% 
  #sample_n(50) %>% 
  select(-region) %>% 
  select_if(function(x) is.character(x) || sum(x) >0)

RPD_CC <- as.data.frame(RPD_CC)
rownames(RPD_CC) <- RPD_CC$kundnr1
RPD_CC <- RPD_CC[,-1]
```

+ top 10 cropcodes by total area by region

```{r}
Top_10_CC <- 
RPD_2012_sub %>% 
  st_set_geometry(NULL) %>% 
  select(region, kundnr1, grodkod, areal) %>% 
  distinct %>% 
  group_by(region, grodkod) %>% 
  summarise(areal = sum(areal)) %>% 
  mutate(areal = areal/sum(areal)*100) %>%
  ungroup %>% 
  mutate(rank = dense_rank(desc(areal))) %>% 
  left_join(crop_codes) %>%
  mutate(crop_name = fct_reorder(crop_name, rank)) %>% 
  group_by(region) %>% 
  mutate(rank = dense_rank(desc(areal))) %>% 
  filter(rank <= 10) %>% 
  arrange(region, rank) %>% 
  mutate(cum = round(cumsum(areal))) 


ggplot(Top_10_CC, aes(x = rank, y = areal, fill = crop_name))+
  geom_bar(stat = "identity")+
  geom_text(aes(x = rank, y = areal+5, label = cum), size = 3)+
  facet_wrap(~region)+
  scale_fill_manual(values=c(brewer.pal(12,"Paired"),c(brewer.pal(12,"Paired"))))+
  theme_bw()+
  theme(legend.position = "bottom",
        legend.title=element_blank())+
  guides(fill=guide_legend(ncol=3))+
  scale_x_continuous(breaks = c(1:10))+
  labs(y = "total area and cumulative area in %")
  
  
  

```

+ cropcodes by 99th quantile of the % of total farm area 

```{r}
Min_5prct_CC <- 
t(apply(RPD_CC, 1, function(x) (x/sum(x))*100)) %>% 
  apply(.,2,function(x) quantile(x, 0.99)) %>% 
  data.frame(max_prop = .) %>% 
  rownames_to_column(var = "grodkod") %>% 
  mutate(grodkod = as.numeric(grodkod)) %>% 
  left_join(crop_codes) %>% 
  arrange(max_prop) %>% 
  select(-cropcode_year) %>% 
  filter(max_prop > 5) %>% 
  mutate(rank = min_rank(desc(max_prop))) %>% 
  arrange(rank) %>% 
  mutate(rank = 1:n()) %>% 
  mutate(crop_name = fct_reorder(crop_name, rank))

ggplot(Min_5prct_CC, aes(x = rank, y = max_prop, fill = crop_name))+
  geom_bar(stat = "identity")+
  scale_fill_manual(values=c(brewer.pal(12,"Paired"),c(brewer.pal(12,"Paired"))))+
  theme_bw()+
  theme(legend.position = "bottom",
        legend.title=element_blank())+
  guides(fill=guide_legend(ncol=2))+
  scale_x_continuous(breaks = c(1:20))+
  labs(y = "%", title = "99th quantile of % accounted for by crop on any farm")
```

```{r}
Top10 <-  Top_10_CC %>% ungroup %>% select(grodkod) %>% unique() %>% arrange(grodkod) %>% `[[`(.,1)
Min_5 <-  Min_5prct_CC %>% select(grodkod) %>% unique() %>% arrange(grodkod) %>% `[[`(.,1)

kept_CC <- 
sort(union(Top10, Min_5)) %>% 
  tibble(grodkod = .) %>% 
  left_join(crop_codes) %>% 
  select(-cropcode_year) %>% 
  mutate(Top10 = grodkod %in% Top10) %>% 
  mutate(Min_5 = grodkod %in% Min_5)

kept_CC
```

+ We exclude all cropcodes that do not fullfill either of the two criteria

```{r}
RPD_CC_sub <- RPD_CC[,colnames(RPD_CC) %in% kept_CC$grodkod]

#exclude farms that have none (at most 1 ha) of the selected crops left

RPD_CC_sub <- RPD_CC_sub[-c(rowSums(RPD_CC_sub) <= 1),]
```

+ k-mean clustering of subsetted farm-crop matrix

```{r}

Results <- tibble(Cluster = 1:50) %>% 
  mutate(kmeans = map(Cluster, ~kmeans(RPD_CC_sub, .x, nstart = 10))) 

Results <-   
Results %>% 
  mutate(stats = map(kmeans, glance)) %>% 
  unnest(stats)

Results %>% 
  select(Cluster, tot.withinss, betweenss) %>% 
  gather(index, value, -Cluster) %>% 
  ggplot(aes(Cluster, value))+
  facet_wrap(~index)+
  geom_line()+
  geom_point()



```

This suggests that ~6 clusters might be reasonable

```{r}
k_mean <- kmeans(RPD_CC_sub, 6, nstart = 100)

k_mean$centers %>% 
  as_tibble() %>% 
  mutate(cluster = 1:n()) %>% 
  gather(grodkod, area, -cluster) %>% 
  mutate(grodkod = as.numeric(grodkod)) %>% 
  left_join(crop_codes) %>% 
  ggplot(aes(x = cluster, y = area, fill = crop_name))+
  geom_bar(stat="identity") +
  theme_bw()+
  theme(legend.position = "bottom",
        legend.title=element_blank())+
  guides(fill=guide_legend(ncol=2))+
  scale_fill_manual(values=c(brewer.pal(12,"Paired"),viridisLite::viridis(12)))



```
```{r}
Centers <- 
  as.data.frame(k_mean$centers) %>% 
  rownames_to_column(var = "Cluster") %>% 
  gather(grodkod, area, -Cluster) %>% 
  mutate(grodkod = as.numeric(grodkod)) %>% 
  left_join(crop_codes) %>% 
  group_by(grodkod) %>% 
  mutate(max = max(area)) %>% 
  filter(max > 2)

Size <- 
data.frame(size = k_mean$size) %>% 
  rownames_to_column(var = "Cluster") 

Clusters <-   
k_mean$cluster %>% 
  data.frame(Cluster = `.`) %>% 
  rownames_to_column(var = "kundnr1") %>% 
  left_join(rownames_to_column(as.data.frame(RPD_CC_sub), var = "kundnr1")) %>% 
  gather(grodkod, area, -kundnr1, -Cluster) %>% 
  mutate(grodkod = as.numeric(grodkod)) %>% 
  left_join(crop_codes) %>% 
  filter(grodkod %in% Centers$grodkod) 

ggplot(Clusters, aes(x = as.factor(grodkod), y = area))+
  geom_boxplot(outlier.size = 1, outlier.alpha = 0.3, aes(fill = crop_name))+
  geom_point(data = Centers, aes(x = as.factor(grodkod), y = area, fill = crop_name), 
             colour = "black", shape = 21)+
  geom_text(data = Size, aes(x = 5, y = 300, label = size))+
  facet_wrap(~Cluster)+theme_bw()+
  theme(legend.position = "bottom",
        legend.title=element_blank())+
  guides(fill=guide_legend(ncol=2))+
  scale_fill_manual(values=c(brewer.pal(12,"Paired"),viridisLite::viridis(12)))


```

The clustering based on cropcodes alone does not reveal many clear clusters. We add the animal data.

```{r}

RPD_DD <- 
RPD_2012_sub %>% 
  st_set_geometry(NULL) %>% 
  select(region, kundnr1, djurid, antal) %>% 
  distinct() %>% 
  filter(!is.na(djurid)) %>% 
  left_join(distinct(select(Livestock_groups, djurid, LSUC))) %>%
  mutate(LSUC = as.numeric(LSUC)) %>% 
  mutate(antal = antal * LSUC) %>%
  ungroup() %>% 
  select(-region, -LSUC) %>% 
  distinct() %>% 
  spread(djurid, antal, fill = 0) %>%
  select_if(function(x) is.character(x) || sum(x) >0)


RPD_DD <- as.data.frame(RPD_DD)
rownames(RPD_DD) <- RPD_DD$kundnr1
RPD_DD <- RPD_DD[,-1]
RPD_DD
```

+ top 10 animal by total number by region

```{r}
Top_10_DD <- 
RPD_2012_sub %>% 
  st_set_geometry(NULL) %>% 
  select(region, kundnr1, djurid, antal) %>% 
  distinct() %>% 
  filter(!is.na(djurid)) %>% 
  left_join(distinct(select(Livestock_groups, djurid, LSUC))) %>%
  mutate(LSUC = as.numeric(LSUC)) %>% 
  mutate(antal = antal * LSUC) %>% 
  select(-kundnr1) %>% 
  group_by(region, djurid) %>% 
  summarise(antal = sum(antal)) %>% 
  mutate(antal = antal/sum(antal)*100) %>%
  ungroup %>%
  mutate(rank = dense_rank(desc(antal))) %>% 
  left_join(distinct(select(Livestock, djurid, djur))) %>% 
  mutate(djur = fct_reorder(djur, rank)) %>% 
  group_by(region) %>% 
  mutate(rank = dense_rank(desc(antal))) %>% 
  filter(rank <= 10) %>% 
  arrange(region, rank) %>% 
  mutate(cum = round(cumsum(antal))) 


ggplot(Top_10_DD, aes(x = rank, y = antal, fill = djur))+
  geom_bar(stat = "identity")+
  geom_text(aes(x = rank, y = antal+2, label = cum), size = 3)+
  facet_wrap(~region)+
  scale_fill_manual(values=c(brewer.pal(12,"Paired"),viridisLite::viridis(12)))+
  theme_bw()+
  theme(legend.position = "bottom",
        legend.title=element_blank())+
  guides(fill=guide_legend(ncol=3))+
  scale_x_continuous(breaks = c(1:10))+
  labs(y = "total LSU cumulative LSU in %")
  
  
  

```





+ k-mean clustering of subsetted farm-crop matrix

```{r}

Results <- tibble(Cluster = 1:50) %>% 
  mutate(kmeans = map(Cluster, ~kmeans(RPD_DD, .x, nstart = 10))) 

Results <-   
Results %>% 
  mutate(stats = map(kmeans, glance)) %>% 
  unnest(stats)

Results %>% 
  select(Cluster, tot.withinss, betweenss) %>% 
  gather(index, value, -Cluster) %>% 
  ggplot(aes(Cluster, value))+
  facet_wrap(~index)+
  geom_line()+
  geom_point()



```

```{r}
set.seed(20180618)
k_mean <- kmeans(RPD_DD, 10, nstart = 100)

k_mean$centers %>% 
  as_tibble() %>% 
  mutate(cluster = 1:n()) %>% 
  gather(djurid, antal, -cluster) %>% 
  mutate(djurid = as.numeric(djurid)) %>% 
  left_join(distinct(select(Livestock, djurid, djur))) %>% 
  ggplot(aes(x = cluster, y = antal, fill = djur))+
  geom_bar(stat="identity") +
  theme_bw()+
  theme(legend.position = "bottom",
        legend.title=element_blank())+
  guides(fill=guide_legend(ncol=4))+
  scale_fill_manual(values=c(brewer.pal(12,"Paired"),viridisLite::viridis(18)))



```

```{r}
Centers <- 
  as.data.frame(k_mean$centers) %>% 
  rownames_to_column(var = "Cluster") %>% 
  gather(djurid, antal, -Cluster) %>% 
  mutate(djurid = as.numeric(djurid)) %>% 
  left_join(distinct(select(Livestock, djurid, djur))) %>% 
  group_by(djurid) %>% 
  mutate(max = max(antal)) %>% 
  filter(max > 100)

Size <- 
data.frame(size = k_mean$size) %>% 
  rownames_to_column(var = "Cluster") 

Clusters <- 
k_mean$cluster %>% 
  data.frame(Cluster = `.`) %>% 
  rownames_to_column(var = "kundnr1") %>%
  left_join(rownames_to_column(as.data.frame(RPD_DD), var = "kundnr1")) %>% 
  gather(djurid, antal, -kundnr1, -Cluster) %>% 
  mutate(djurid = as.numeric(djurid)) %>% 
  left_join(distinct(select(Livestock, djurid, djur)))

Clusters %>% 
filter(djurid %in% Centers$djurid) %>% 
  ggplot(aes(x = as.factor(djurid), y = antal))+
  geom_boxplot(outlier.size = 1, outlier.alpha = 0.3, aes(fill = djur))+
  geom_point(data = Centers, aes(x = as.factor(djurid), y = antal, fill = djur), colour = "black", shape = 21)+
  geom_text(data = Size, aes(x = 5, y = 500, label = size))+
  facet_wrap(~Cluster)+
  theme_bw()+
  theme(legend.position = "bottom",
        legend.title=element_blank())+
  guides(fill=guide_legend(ncol=4))+
  scale_fill_manual(values=c(brewer.pal(12,"Paired"),viridisLite::viridis(12)))


```

As we did no prior filtering of the data, the cluster pick up mostly the largest farms, specialized in 

*note: if the seed changed these clusters will likely not correspond*

+ Milk production (cluster 5, 10 - [25,158])
+ Porc production (cluster 2, 6 and 9 - [11,2,2])
+ Chicken production (cluster 8 - [4])
+ Bovine prodcution (cluster 7 - [3])

Closer look at the farms in this cluster 

```{r}
Clusters %>% 
  filter(Cluster %in% c(2,5,6,7,8,9,10)) %>% 
  select(-djurid) %>% 
  spread(djur, antal)
```




```{r}
#RPD_CC[RPD_CC > 1] <- 1

RPD_dist <- vegdist(RPD_CC)

Hclust_RPD <- hclust(RPD_dist)

plot(Hclust_RPD)

CooC <- cooccur(RPD_CC, type = "site_spp", spp_names = TRUE ) 

CooC$results %>% as_tibble() %>%  filter(p_lt > 0.05)



```



 








### Farms with largest N of animals by animal
```{r}
RPD_2012_sub %>% 
  st_set_geometry(NULL) %>% 
  filter(!is.na(djurid)) %>%
  left_join(county_codes) %>% 
  select(kundnr1, County, djur, antal) %>% 
  distinct() %>% 
  group_by(djur) %>% 
  arrange(djur, desc(antal)) %>% 
  top_n(5)


```

### distribution of animal/farm
```{r}
RPD_2012_sub %>% 
  st_set_geometry(NULL) %>% 
  filter(!is.na(djur)) %>% 
  group_by(kundnr1) %>% 
  summarise(tot_lifestock = sum(antal)) %>% 
  ggplot(aes(x = tot_lifestock)) +
  geom_histogram(binwidth = 0.15, fill = "orange", colour = NA, alpha = 0.8)+
  stat_density(geom="line", aes(y=0.15 * ..count..), colour = "red", size = 1)+
  scale_x_log10()+
  theme_minimal()+
  labs(x = "lifestock units" )
```

+ how many farms have *any* lifestock?

```{r}
RPD_2012_sub %>% 
  st_set_geometry(NULL) %>% 
  group_by(kundnr1, lan) %>% 
  summarise(tot_lifestock = sum(antal)) %>%
  mutate(tot_lifestock = ifelse(is.na(tot_lifestock), 0,1)) %>% 
  left_join(county_codes) %>% 
  group_by(County) %>% 
  summarise(`% lifestock holders` = sum(tot_lifestock) / n() * 100, lan = unique(lan)) %>% 
  mutate(County = fct_reorder(County, `% lifestock holders`)) %>% 
  mutate(target = ifelse(lan %in% c("M", "AC", "F"), "yes", "no")) %>% 
  ggplot(aes(y = `% lifestock holders`, x = County, alpha = target, label = ))+
  geom_bar(stat = "identity", fill = "orange")+
  geom_text(aes(y = 3, label = paste(signif(`% lifestock holders`,2), "%")))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  coord_flip()+
  theme_minimal()+
  labs(title = "% of kundnr with any lifestock")+
  scale_alpha_manual(values = c(0.6, 1), guide = "none")
```

# focusing on target regions: Jönköping, (norra) Skåne, Västernbotten

```{r}

RPD_2012_Reg <- 
  RPD_2012_sub %>% 
  filter(lan %in% c("M", "AC", "F"))
  
```

## farm size by län

```{r}

RPD_2012_Reg %>% 
  st_set_geometry(NULL) %>%
  group_by(kundnr1, lan) %>% 
  summarise(tot_area = sum(blockarea)) %>% 
  left_join(county_codes) %>% 
  ggplot(aes(x = tot_area)) +
  geom_histogram(binwidth = 0.1, fill = "forestgreen", colour = NA)+
  scale_x_log10()+
  facet_wrap(~County)+
  theme_minimal()+
  labs(x = "total farm size in ha", title = "log-normal distribution of land are per kundnr" )


```


```{r}

RPD_2012_Reg %>% 
  st_set_geometry(NULL) %>%
  group_by(kundnr1, lan) %>% 
  summarise(tot_area = sum(blockarea)) %>% 
  mutate(category = cut(tot_area, breaks=c(0, 20, 50, 100, 300, 500, Inf))) %>% 
  group_by(lan, category) %>%
  summarize(N = n()) %>% 
  group_by(lan) %>% 
  mutate(prct = signif(100*(N/sum(N)), 2)) %>% 
  left_join(county_codes) %>% 
  mutate(category = fct_rev(category)) %>% 
  ggplot(aes(x = category, y = N))+
  geom_bar(stat = "identity", fill = "forestgreen")+
  geom_text(aes(label = prct, y = N/2), colour = "white", size = 3)+
  facet_wrap(~County, ncol = 1)+
  coord_flip()+
  theme_minimal()+
  labs(x = "farm size in ha", title = "number and % of farms in each size category")

```

```{r}

RPD_2012_Reg %>% 
  st_set_geometry(NULL) %>%
  group_by(kundnr1, lan) %>% 
  summarise(tot_area = sum(blockarea)) %>% 
  mutate(category = cut(tot_area, breaks=c(0, 20, 50, 100, 300, 500, Inf))) %>% 
  group_by(lan, category) %>%
  summarize(tot_area = sum(tot_area)) %>% 
  group_by(lan) %>% 
  mutate(prct = signif(100*(tot_area/sum(tot_area)), 2)) %>% 
  left_join(county_codes) %>% 
  mutate(category = fct_rev(category)) %>% 
  ggplot(aes(x = category, y = tot_area))+
  geom_bar(stat = "identity", fill = "forestgreen")+
  geom_text(aes(label = prct, y = tot_area/2 + 4000), colour = "black", size = 3)+
  facet_wrap(~County, ncol = 1)+
  coord_flip()+
  theme_minimal()+
  labs(x = "farm size in ha", y = "cumulative area", title = "cumulative area and % of area in each size category")

```

```{r}
RPD_2012_Reg %>%
  st_set_geometry(NULL) %>%
  group_by(lan,kundnr1) %>% 
  summarise(blockarea = sum(blockarea)) %>%
  group_by(lan) %>% 
  arrange(desc(blockarea)) %>% 
  mutate(cum_area = cumsum(blockarea)) %>% 
  mutate(cum_area = 100*cum_area / max(cum_area)) %>% 
  mutate(cum_n = 1:n()) %>% 
  mutate(cum_n = 100*cum_n/max(cum_n)) %>% 
  left_join(county_codes) %>% 
  ggplot(aes(cum_n, cum_area, colour = County))+
  geom_line(size = 1, alpha = 0.8)+
  scale_color_brewer(palette = "Set1")+
  scale_x_continuous(limits = c(0,100), breaks = seq(0,100,10))+
  scale_y_continuous(limits = c(0,100), breaks = seq(0,100,10))+
  theme_bw()
```


```{r}
Area_kndnr_M <- 
RPD_2012 %>%
  filter(lan == "M") %>% 
  filter(st_contains(filter(Sweden_lan, LANSNAMN == "Skåne län"),
                     filter(RPD_2012, lan == "M"), sparse = FALSE)) %>% 
  group_by(kundnr1) %>% 
  summarise(geometry = st_union(geometry, by_feature = FALSE), blockarea = sum(blockarea)) %>% 
  Area_kndnr_M %>% mutate(Area = cut(blockarea, breaks=c(0, 20, 50, 100, 300, 500, Inf))) %>% 
  mutate(Area = as.character(Area))
```

```{r}
Area_kndnr_M %>% 
 # st_simplify() %>% 
  mutate(Area = cut(blockarea, breaks=c(0, 20, 50, 100, 300, 500, Inf))) %>%
  ggplot(aes(fill = Area, colour = Area))+
  geom_sf()+
  geom_sf(data = filter(Sweden_lan, LANSNAMN == "Skåne län"), fill = NA, colour = "black")+
  coord_sf(crs = st_crs(RPD_2012))+
  scale_fill_viridis(discrete = T)+
  scale_colour_viridis(discrete = T)+
  theme_bw()+
  labs(title = "Skåne län")

types = unique(Area_kndnr_M$Area)
N = length(types)
cols <- leaflet::colorFactor(viridis_pal(option = "C")(N), domain = types)

Area_kndnr_M %>% 
  st_transform("+proj=longlat +datum=WGS84") %>% 
  leaflet() %>%
  addPolygons(
    stroke = FALSE, # remove polygon borders
    fillColor = ~cols(Area), # set fill color with function from above and value
    fillOpacity = 0.8, smoothFactor = 0.5) %>% 
  addLegend(position = 'topright',
            colors = viridis_pal(option = "C")(N),
            labels = types) %>% 
  addTiles()
```

```{r}
Area_kndnr_F <- 
RPD_2012 %>%
  filter(lan == "F") %>% 
  filter(st_contains(filter(Sweden_lan, LANSNAMN == "Jönköpings län"),
                     filter(RPD_2012, lan == "F"), sparse = FALSE)) %>% 
  group_by(kundnr1) %>% 
  summarise(geometry = st_union(geometry, by_feature = FALSE), blockarea = sum(blockarea))

Area_kndnr_F %>% 
  mutate(Area = cut(blockarea, breaks=c(0, 20, 50, 100, 300, 500, Inf))) %>%
  ggplot(., aes(fill = Area, colour = Area))+
  geom_sf()+
  geom_sf(data = filter(Sweden_lan, LANSNAMN == "Jönköpings län"), fill = NA, colour = "black")+
  coord_sf(crs = st_crs(RPD_2012))+
  scale_fill_viridis(discrete = T)+
  scale_colour_viridis(discrete = T)+
  theme_bw()+
  labs(title = "Jönköpings län")
```

```{r}
Area_kndnr_AC <- 
RPD_2012 %>%
  filter(lan == "AC") %>% 
  filter(st_contains(filter(Sweden_lan, LANSNAMN == "Västerbottens län"),
                     filter(RPD_2012, lan == "AC"), sparse = FALSE)) %>% 
  group_by(kundnr1) %>% 
  summarise(blockarea = sum(blockarea)) %>% 
  mutate(Area = cut(blockarea, breaks=c(0, 20, 50, 100, 300, 500, Inf))) %>% 
  mutate(Area = as.character(Area))
```

```{r}
Vp <- 
  Area_kndnr_AC %>% 
  mutate(Area = cut(blockarea, breaks=c(0, 20, 50, 100, 300, 500, Inf))) %>%
  ggplot(., aes(fill = Area, colour = Area))+
  geom_sf()+
  geom_sf(data = filter(Sweden_lan, LANSNAMN == "Västerbottens län"), fill = NA, colour = "black")+
  scale_fill_viridis(discrete = TRUE)+
  scale_colour_viridis(discrete = TRUE)+
  theme_bw()+
  labs(title = "Västerbottens län")


types = unique(Area_kndnr_AC$Area)
N = length(types)
cols <- leaflet::colorFactor(viridis_pal(option = "C")(N), domain = types)

Area_kndnr_AC %>% 
  st_transform("+proj=longlat +datum=WGS84") %>% 
  leaflet() %>%
  addPolygons(
    stroke = FALSE, # remove polygon borders
    fillColor = ~cols(Area), # set fill color with function from above and value
    fillOpacity = 0.8, smoothFactor = 0.5) %>% 
  addLegend(position = 'topright',
            colors = viridis_pal(option = "C")(N),
            labels = types) %>% 
  addTiles()
```







cluster analysis just based on crop area
```{r}

Kund_crop <- 
APD_2016_sub %>% 
  dplyr::select(kundnr1, GRDKOD_MAR, AREA_crop) %>% 
  st_set_geometry(NULL) %>% 
  distinct() %>% 
  spread(GRDKOD_MAR, AREA_crop, fill = 0) %>% 
  select_if(function(x) sum(x) > 0) %>% 
  ungroup

Kund_crop_Cl <- 
  Kund_crop %>% 
  dplyr::select(-kundnr1) %>%
  #mutate_all(function(x) x/max(x)) %>% 
  princomp()
  

fviz_nbclust(Kund_crop_Cl, kmeans, method = "wss", nboot = 1, k.max = 20)
  

kmeans_KC <- Kund_crop_Cl %>% 
  kmeans(14)
  

fviz_cluster(kmeans_KC, Kund_crop_Cl)+
  scale_x_continuous(limits = c(0,10))+
  scale_y_continuous(limits = c(-10,10))
  
  library("factoextra")
fviz_nbclust(my_data, kmeans, method = "gap_stat")

APD_2016_sub %>% 
filter(KUND_LOPNR == 1805) %>% 
select(GRDKOD_MAR) %>% 
  distinct() %>% 
  plot

```



```{r}
p <- RPD_2012_sub %>% 
  st_set_geometry(NULL) %>%
  select(blockid, areal, blockarea) %>% 
  distinct() %>% 
  group_by(blockid) %>% 
  summarise(areal = sum(areal), blockarea = unique(blockarea)) %>% 
  rowwise() %>% 
  mutate(match = ifelse(between(areal, 
                                blockarea - 0.05 * blockarea, 
                                blockarea + 0.05 * blockarea), 
                        "yes", "no")) %>% 
  ggplot(aes(x = blockarea, y = areal, colour = match))+
  geom_point(alpha = 0.2)+
  geom_abline(slope = 1)
  
p <- p + theme_bw()
ggplotly(p) %>% toWebGL()
  
  
```

```{r}
st_read("Shapes/prod_län_combi_byyann_skarning2.shp") %>%  head
```


